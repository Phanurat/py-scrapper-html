;/*FB_PKG_DELIM*/

__d("LSDeleteBackupOnClientStoredProcedure",["LSDeleteBackupOnClient","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.backupId;d[1]=b.traceContext;d[2]=b.clearBackupsTable;d[3]=b.traceId;d[4]=b.errorMsg;d[5]=b.isFlowSuccess;return c("LSDeleteBackupOnClient").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MWChatEncryptedBackupsDeleteBackupsOnClientNOP",["LSDeleteBackupOnClientStoredProcedure","LSFactory","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][auto-restore] Error when deleting backups on client after device setup registration failed: ",""]);i=function(){return a};return a}function a(a,e){c("LSDeleteBackupOnClientStoredProcedure")(c("LSFactory")(e),{backupId:a,clearBackupsTable:!0,isFlowSuccess:!1})["catch"](function(a){d("WALogger").ERROR(i(),a)});return(h||(h=b("Promise"))).resolve()}g["default"]=a}),98);
__d("LSStoreAuthoritativeClientState",["LSArrayGetObjectAt","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][storeAuthoritativeClientState] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?(d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,1])),d[10].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[10].set("error_message",""),d[2]=d[10]):(f=e.item,c.sequence([function(a){return d[15]=f.backupTenancy,d[14]=f.encryptionVersion,c.i64.neq(void 0,void 0)?c.resolve(d[10]=void 0):c.sequence([function(a){return d[16]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[17]?d[26]=(d[16].push(c.i64.cast([0,0])),d[16]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[26]=(d[16].push(c.i64.cast([0,2])),d[16]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[19]=a[0],a})},function(a){return d[19]?d[26]=(d[16].push(c.i64.cast([0,3])),d[16]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[26]=(d[16].push(c.i64.cast([0,4])),d[16]):0,d[21]=c.createArray(),d[22]=c.i64.of_int32(d[16].length),c.i64.gt(d[22],c.i64.cast([0,0]))?c.loopAsync(d[22],function(a){return d[26]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[16],d[26]).then(function(a){return a=a,d[27]=a[0],d[28]=a[1],a})},function(a){return d[29]=(d[21].push(d[27]),d[21])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[26]=c.createArray(),d[27]=c.i64.of_int32(d[21].length),c.i64.gt(d[27],c.i64.cast([0,0]))?c.loopAsync(d[27],function(a){return d[29]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],d[29]).then(function(a){return a=a,d[30]=a[0],d[31]=a[1],a})},function(a){return d[32]=(d[26].push(c.i64.to_string(d[30])),d[26])}])}):c.resolve()},function(a){return d[28]=d[26].join(","),d[23]=d[28]}])},function(a){return d[21].some(function(a){return c.i64.eq(d[14],a)})?d[24]=d[14]:d[24]=void 0,c.i64.neq(d[24],void 0)?d[25]=d[24]:d[25]=void 0,d[10]=d[25]}])},function(e){return c.i64.neq(d[10],void 0)?d[11]=d[10]:d[11]=c.i64.cast([0,0]),c.i64.neq(d[15],void 0)?d[12]=d[15]:d[12]=c.i64.cast([0,1]),c.i64.neq(f.deviceId,void 0)?c.sequence([function(e){return d[16]=a[2].get("device_key"),a[2],d[17]=d[16].get("device_public_key"),d[16],c.filter(c.db.table(168).fetch([[[a[0]]]]),function(b){return c.i64.eq(b.backupId,a[0])&&c.blobs.eq(b.devicePublicKeyBlob,d[17])}).next().then(function(e,f){f=e.done;e=e.value;return f?c.sequence([function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,4])})},function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure] No matching row in backup client state found"),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure","No matching row in backup client state found",d[20],c.i64.cast([0,3]))},function(a){return d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,19])),d[21].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[21].set("error_message",""),d[18]=d[21]}]):(e.item,c.sequence([function(b){return c.forEach(c.db.table(168).fetch([[[a[0]]]]),function(b){var d=b.update;b.item;return d({deviceId:a[1],authorityLevel:c.i64.cast([0,80])})})},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,2])})},function(b){return c.forEach(c.db.table(169).fetch([[[a[0]]],"fk_secure_encrypted_backups_client_state"]),function(a){var b=a.update;a.item;return b({authorityLevel:c.i64.cast([0,80])})})},function(a){return d[18]=void 0}]))})},function(a){return d[13]=d[18]}]):c.resolve((d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,24])),d[16].set("stored_procedure","LSEncryptedBackupsStoreAuthoritativeClientStateStoredProcedure"),d[16].set("error_message",""),d[13]=d[16]))},function(a){return d[2]=d[13]}]))})},function(a){return d[4]=c.i64.of_float(Date.now()),d[5]=c.i64.random(),d[7]="Finishing execution. Execution time: ",d[8]=c.i64.to_string(c.i64.sub(d[4],d[0])),d[9]=" ms",d[6]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][storeAuthoritativeClientState] ",d[6],d[7],d[6],d[8],d[6],d[9]].join("")),c.i64.eq(c.i64.mod_(d[5],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[10]=",",d[11]=c.createArray(),void 0!==void 0?d[12]=(d[11].push(void 0),d[11]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"storeAuthoritativeClientState",[d[7],d[10],d[8],d[10],d[9]].join(""),d[11],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[2]}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSStoreAuthoritativeClientStateStoredProcedure",["LSStoreAuthoritativeClientState","cr:8709"],(function(a,b,c,d,e,f,g){function a(a,b){var d=[];d[0]=b.backupId;d[1]=b.deviceId;d[2]=b.localKeys;return c("LSStoreAuthoritativeClientState").apply(void 0,d.concat([a]))}g["default"]=a}),98);
__d("MWChatEncryptedBackupsStoreAuthoritativeClientStateNOP",["I64","LSFactory","LSShape","LSStoreAuthoritativeClientStateStoredProcedure","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][auto-restore] Error when storing client state after add device was successful: ",""]);i=function(){return a};return a}function a(a,b,e,f){return c("LSStoreAuthoritativeClientStateStoredProcedure")(c("LSFactory")(f),{backupId:a,deviceId:b,localKeys:e}).then(function(a){return a[0]!=null?[a[0]]:[void 0]})["catch"](function(a){d("WALogger").ERROR(i(),a);return[d("LSShape").ofRecord({error_code:(h||(h=d("I64"))).neg_one,error_message:"Error when storing client state, likely caused by database corruption",stored_procedure:"LSStoreAuthoritativeClientState"})]})}g["default"]=a}),98);